<!-- prettier-ignore -->
<div id="{{ window_id }}" class="system-window">
  {% if show_back_btn %}
    <div class="back-btn" onclick="switch_to_main_window()"></div>
  {% endif %}

  <form class="system-from" id="{{ form_id }}">
      
      <!-- hidden type -->
      <input type="hidden" name="type" value="{{ route_name | default(form_id.replace('_form','')) }}">
  
      {% if task_id %}
        <input type="hidden" id="task_id" name="task_id" value="{{ task_id }}">
      {% endif %}
  
      {# USER EDIT MODE #}
      {% if show_user_name %}
        <label for="user_name">User name</label>
        <input
          type="text"
          id="user_name"
          name="user_name"
          value="{{ input_value | default('') }}"
        />
      {% endif %}
  
      {# TASK EDIT MODE #}
      {% if input_name %}
        <label for="{{ input_name }}">{{ input_label }}</label>
        <input
          type="text"
          id="{{ input_name }}"
          name="{{ input_name }}"
          value="{{ input_value | default('') }}"
        />
      {% endif %}
  
      {% if show_number_inputs %}
        <label for="coin_reward">Coin reward</label>
        <input type="number" id="coin_reward" name="coin_reward" value="{{ coin_reward | default(2) }}" />
  
        <label for="xp_reward">XP reward</label>
        <input type="number" id="xp_reward" name="xp_reward" value="{{ xp_reward | default(2) }}" />
      {% endif %}
  
      {% if show_time_inputs %}
        <label for="start_time">Start time</label>
        <input type="time" id="start_time" name="start_time" />
  
        <label for="end_time">End time</label>
        <input type="time" id="end_time" name="end_time" />
      {% endif %}
  
      {% if show_repeat_days %}
        <fieldset>
          <legend>Repeat on (select days)</legend>
          {% for day in ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'] %}
            <label><input type="checkbox" name="repeat_days" value="{{ day }}" /> {{ day|capitalize }}</label>
          {% endfor %}
        </fieldset>
      {% endif %}
  
      <input type="submit" value="{{ submit_text | default('Submit') }}" />
  </form>
</div>
<script type="module">
  import {
    Task,
    tasksMap,
    concecensesMap,
  } from "{{ url_for('static', filename='script/modules/tasks.js') }}";
  import { switch_to_main_window } from "{{ url_for('static', filename='script/modules/system_windows.js') }}";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("{{ form_id }}");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (form.id == "edit_task_form") {
        const task_id = form.elements["task_id"].value;
        const task_name = form.elements["task_name"].value;
        const coin_reward = parseInt(form.elements["coin_reward"].value);
        const xp_reward = parseInt(form.elements["xp_reward"].value);
        const start_time = form.elements["start_time"].value;
        const end_time = form.elements["end_time"].value;
        const repeatDays = Array.from(
          form.querySelectorAll('input[name="repeat_days"]:checked')
        ).map((checkbox) => checkbox.value);

        const task = tasksMap.get(Number(task_id));
        task.update_task({
          name: task_name,
          coinReward: coin_reward,
          expReward: xp_reward,
          start_time: start_time,
          end_time: end_time,
          completed: task["completed"],
          failed: task["failed"],
          repeat_days: repeatDays,
        });
        switch_to_main_window();
      }

      if (form.id == "edit_user_form") {
        const new_user_name = form.elements["user_name"].value;

        currentUser.updateUserSettings(new_user_name);

        switch_to_main_window();
      }

      if (form.id === "edit_concecense_form") {
        const windowEl = document.getElementById("edit_concecense_window");
        const concecenseId = Number(windowEl.dataset.concecenseId);

        const concecense = concecensesMap.get(concecenseId);
        if (!concecense) return console.error("Concecense not found");

        const newName = form.elements["concecense_name"].value;

        await concecense.update_concecenses({ name: newName });
        switch_to_main_window();
      }
    });
  });
</script>
