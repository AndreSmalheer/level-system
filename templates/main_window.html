<!-- prettier-ignore -->
<div id="main_window" class="system-window">
  <div id="status_container">
    <div id="settings_icon">
      <img src="{{ url_for('static', filename='images/icons/settings.png') }}" alt="Settings" />
    </div>
    <h1 id="name"></h1>

    <div id="level_coin_container">
      <div id="level_container">
        <h1></h1>
        <h2>Level</h2>
      </div>
      <div id="coin_container">
        <h1></h1>
        <h2>Coins</h2>
      </div>
    </div>

    <div id="progress_container">
      <div id="progress_bar"></div>
    </div>
    <div id="progress_texts">
      <span id="current_xp"></span>
      <span id="xp_label">XP</span>
      <span id="xp_needed">20</span>
    </div>
  </div>

  <ul id="selection_list">
    <li class="active">Tasks</li>
    <li>Consequences</li>
  </ul>

  <div id="tasks_container" class="tab-content tasks-tab"></div>
  <div id="consequences_container" class="tab-content consequences-tab"></div>

  <button id="add_tasks_btn" class="add_btn" onclick="switch_window('add_task_window')">+</button>
  <button id="add_consequences_btn" class="add_btn" onclick="switch_window('add_concecenses_window')">+</button>
</div>
<!-- prettier-ignore -->

<script type="module">
  import {
    switch_to_main_window,
    show_window,
    switch_window,
  } from "{{ url_for('static', filename='script/system_windows.js') }}";

  import { set_xp } from "{{ url_for('static', filename='script/progress.js') }}";

  function onListItemClick(li) {
    const li_name = li.textContent.toLowerCase()
    document.querySelectorAll(".tab-content, .add_btn").forEach(el => el.style.display = "none")
  
    const contentId = `${li_name}_container`
    const buttonId = `add_${li_name}_btn`
  
    const content = document.getElementById(contentId)
    const button = document.getElementById(buttonId)
  
    if (content) content.style.display = "flex"
    if (button) button.style.display = "block"
  
    // Update active class
    selection_list_li.forEach(item => item.classList.remove("active"))
    li.classList.add("active")
  }

  const selection_list = document.getElementById("selection_list")
  const selection_list_li = selection_list.querySelectorAll("li")
  for (const li of selection_list_li) {
    li.addEventListener("click", () => onListItemClick(li))
  }

  document.querySelectorAll(".tab-content, .add_btn").forEach(el => el.style.display="none"), document.getElementById("add_tasks_btn").style.display="block", document.getElementById("tasks_container").style.display="flex"

  const settings_icon = document.getElementById("settings_icon")
  settings_icon.addEventListener(
    "click",
    () =>{
      switch_window("edit_user_settings");
    }
  )

  function load_user_data(level, xp, coins, xpNeeded, user_name) {
    console.log("Loading user data...");
    if (user_name == "none") {
      user_data = false;
      return;
    }

    document.getElementById("level_container").querySelector("h1").innerHTML =
      level;

    document.getElementById("coin_container").querySelector("h1").innerHTML =
      coins;

    document.getElementById("xp_needed").innerHTML = xpNeeded;

    document.getElementById("current_xp").innerHTML = xp;

    set_xp(xp, xpNeeded);

    document.getElementById("name").innerHTML = user_name;
  }

  document.addEventListener("DOMContentLoaded", () => {
    load_user_data(
      currentUser.level,
      currentUser.xp,
      currentUser.coins,
      currentUser.xpToNextLevel,
      currentUser.name
    );
  });

  document.addEventListener(
  "click",
  () => {
    const activateMsg = document.getElementById("activate_msg");
    if (activateMsg) activateMsg.style.display = "none";

    if (currentUser && currentUser.name !== "none") {
      switch_to_main_window();
    } else {
      show_window("add_user_window");
    }
  },
  { once: true }
);

</script>
